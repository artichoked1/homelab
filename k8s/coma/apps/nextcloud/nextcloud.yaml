apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nextcloud
  namespace: nextcloud
spec:
  chart:
    spec:
      chart: nextcloud
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: nextcloud
        namespace: flux-system
      version: 5.5.4
  interval: 1m0s
  values:
    nextcloud:
      host: nc.artichoke.cc
      username: admin
      existingSecret:
        enabled: true
        secretName: nextcloud-credentials
        usernameKey: initial-user-username
        passwordKey: initial-user-password
        tokenKey: metrics-token
        smtpUsernameKey: smtp-username
        smtpPasswordKey: smtp-password
        smtpHostKey: smtp-host
      mail:
        enabled: true
        fromAddress: ${NOREPLY_EMAIL}
        domain: smtp.artichoke.cc
        smtp:
          host: smtp.artichoke.cc
          port: 465
          secure: ssl
          authtype: LOGIN
      configs:
        z-redis.config.php: |-
          <?php
          $CONFIG = array (
            'memcache.local' => '\OC\Memcache\Redis',
            'memcache.locking' => '\OC\Memcache\Redis',
            'memcache.distributed' => '\OC\Memcache\Redis',
            'redis' => [
              'host' => 'main.redis-clusters.svc.cluster.local',
              'port' => 6379,
            ]
          );
      extraVolumes:
        - name: nsfiles
          nfs:
            server: truenas.artichoke.network
            path: "/mnt/Main/Ns Files"
            readOnly: false
      extraVolumeMounts:
        - name: nsfiles
          mountPath: /nsfiles
    cronjob:
      enabled: true
    persistence:
      enabled: true
      size: 2Gi
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        labels:
          release: prometheus-stack
    externalDatabase:
      enabled: true
      type: postgresql
      host: main-postgres-rw.databases.svc.cluster.local
      database: nextcloud
      existingSecret:
        enabled: true
        secretName: nextcloud-postgres-auth
        usernameKey: username
        passwordKey: password
