# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/app-template-4.2.0/charts/other/app-template/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudflared
  namespace: cloudflared
spec:
  chart:
    spec:
      chart: app-template
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      version: 3.2.1
  interval: 1m0s
  values:
    controllers:
      main:
        strategy: Recreate
        containers:
          main:
            env:
              TZ: Australia/Adelaide
              TUNNEL_TOKEN:
                valueFrom:
                  secretKeyRef:
                    name: cloudflared-tunnel-token
                    key: tunnel-token
            image:
              repository: cloudflare/cloudflared
              tag: latest
              pullPolicy: IfNotPresent
            securityContext:
              sysctls:
                # Allows ICMP traffic (ping, traceroute) to resources behind cloudflared.
                - name: net.ipv4.ping_group_range
                  value: "65532 65532"
            command:
              - cloudflared
              - tunnel
              - --no-autoupdate
              - --loglevel
              - debug
              - --metrics
              - 0.0.0.0:2000
              - run
            probes:
              liveness:
                enabled: true
                custom: true
                type: HTTP
                spec:
                  httpGet:
                    path: /ready
                    port: 2000
                    failureThreshold: 1
                    initialDelaySeconds: 10
                    periodSeconds: 10
