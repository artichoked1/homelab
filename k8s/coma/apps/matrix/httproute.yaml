apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: matrix
  namespace: matrix
spec:
  parentRefs:
    - name: web-gateway
      namespace: networking
      sectionName: artichoke-cc-https
  hostnames:
    - "matrix.artichoke.cc"
    - "artichoke.cc"
    - "mas.artichoke.cc"
    - "element.artichoke.cc"
  rules:
    - matches:
        - path:
            type: RegularExpression
            value: "^/_matrix/client/(.*)/(login|logout|refresh)"
      backendRefs:
        - name: mas-main
          port: 8081

    - matches:
        - path:
            type: PathPrefix
            value: "/"
      backendRefs:
        - name: synapse-matrix-synapse
          port: 8008
      # Narrow by host via hostnames list
      hostnames:
        - "matrix.artichoke.cc"

    - matches:
        - path:
            type: PathPrefix
            value: "/.well-known/matrix/"
      backendRefs:
        - name: synapse-wellknown-lighttpd
          port: 80
      hostnames:
        - "artichoke.cc"

    - matches:
        - path:
            type: PathPrefix
            value: "/"
      backendRefs:
        - name: mas-main
          port: 8081
      hostnames:
        - "mas.artichoke.cc"

    - matches:
        - path:
            type: PathPrefix
            value: "/"
      backendRefs:
        - name: element
          port: 80
      hostnames:
        - "element.artichoke.cc"
