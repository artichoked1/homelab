apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mcaptcha
  namespace: mcaptcha
spec:
  chart:
    spec:
      chart: app-template
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      version: 3.2.1
  interval: 1m0s
  values:
    controllers:
      main:
        strategy: Recreate

        containers:
          main:
            env:
              MCAPTCHA_debug: false
              MCAPTCHA_commercial: false
              MCAPTCHA_source_code: https://github.com/mCaptcha/mCaptcha
              MCAPTCHA_allow_registration: false
              MCAPTCHA_allow_demo: false

              MCAPTCHA_database_POOL: 4
              MCAPTCHA_redis_URL: redis://main.redis-clusters.svc.cluster.local
              MCAPTCHA_server_DOMAIN: localhost
              MCAPTCHA__server_COOKIE_SECRET:
                valueFrom:
                  secretKeyRef:
                    name: mcaptcha-cookie-secret
                    key: secret
              MCAPTCHA__server_IP: 0.0.0.0
              PORT: 7000
              MCAPTCHA_captcha_SALT:
                valueFrom:
                  secretKeyRef:
                    name: mcaptcha-captcha-salt
                    key: secret
              MCAPTCHA_captcha_GC: 30
              MCAPTCHA_captcha_RUNNERS: 4
              MCAPTCHA_captcha_QUEUE_LENGTH: 2000
              MCAPTCHA_captcha_ENABLE_STATS: true

              MCAPTCHA_captcha_DEFAULT_DIFFICULTY_STRATEGY_avg_traffic_difficulty: 50000
              MCAPTCHA_captcha_DEFAULT_DIFFICULTY_STRATEGY_peak_sustainable_traffic_difficulty: 3000000
              MCAPTCHA_captcha_DEFAULT_DIFFICULTY_STRATEGY_broke_my_site_traffic_difficulty: 5000000
              MCAPTCHA_captcha_DEFAULT_DIFFICULTY_STRATEGY_duration: 30
              MCAPTCHA_captcha_DEFAULT_DIFFICULTY_STRATEGY_avg_traffic_time: 1
              MCAPTCHA_captcha_DEFAULT_DIFFICULTY_STRATEGY_peak_sustainable_traffic_time: 3
              MCAPTCHA_captcha_DEFAULT_DIFFICULTY_STRATEGY_broke_my_site_traffic_time: 5

              MCAPTCHA_smtp_FROM: 
              MCAPTCHA_smtp_REPLY:
              MCAPTCHA_smtp_URL:
              MCAPTCHA_smtp_USERNAME:
              MCAPTCHA_smtp_PASSWORD:
              MCAPTCHA_smtp_PORT:

            image:
              repository: mcaptcha/mcaptcha
              tag: latest
              pullPolicy: IfNotPresent

    service:
      main:
        controller: main
        ports:
          http:
            port: 8096

    persistence:
      data:
        storageClass: "local-path"
        accessMode: ReadWriteOnce
        size: 1Gi
        globalMounts:
          - path: /config
